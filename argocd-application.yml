name: $(Date:yyyyMMdd)$(Rev:.r)-ArgoCD
trigger: none
pr: none

variables:
  AWS_SERVICE_CONNECTION: 'alaa-s'
  AWS_REGION: 'us-east-1'
  CLUSTER_NAME: 'alaa-devops-project-cluster' 
  IMAGE_REPOSITORY: 'alaaynassar7/motivational-app'
  GIT_REPO_URL: 'https://github.com/alaaynassar7/end-to-end-devops-project-v2.git'
  HELM_CHART_PATH: 'motivational-app-chart' 
  NAMESPACE: 'alaa'

pool:
  name: 'Self hosted pools'
  demands:
    - Agent.Name -equals alaaynassar-VMware

jobs:
- job: ArgoSync
  displayName: 'ArgoCD Sync / Rollout'
  steps:
  - checkout: self

  # 1. Update Kubeconfig and retrieve API Gateway Endpoint
  - task: AWSShellScript@1
    displayName: Configure kubeconfig
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        aws eks update-kubeconfig --name "$(CLUSTER_NAME)" --region "$(AWS_REGION)"
        
        APIGW_URL=$(aws apigatewayv2 get-apis --region "$(AWS_REGION)" --query "Items[?contains(Name, 'alaa-devops-project')].ApiEndpoint" --output text)
        
        if [ "$APIGW_URL" == "None" ] || [ -z "$APIGW_URL" ]; then
             APIGW_URL="https://placeholder-url.com"
        fi
        echo "##vso[task.setvariable variable=APIGW_URL]$APIGW_URL"

  # 2. Authenticate with Docker Hub
  - task: Docker@2
    displayName: Docker Login
    inputs:
      command: login
      containerRegistry: 'alaa-docker'

  # 3. Create Image Pull Secret in Target Namespace
  - task: AWSShellScript@1
    displayName: Create Image Pull Secret
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        
        DOCKER_AUTH=$(cat ~/.docker/config.json | jq -r '.auths["https://index.docker.io/v1/"].auth' | base64 -d)
        DOCKER_USER=$(echo $DOCKER_AUTH | cut -d: -f1)
        DOCKER_PASS=$(echo $DOCKER_AUTH | cut -d: -f2-)

        kubectl create namespace $(NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -
        
        kubectl delete secret regcred -n $(NAMESPACE) --ignore-not-found
        kubectl create secret docker-registry regcred \
          --namespace $(NAMESPACE) \
          --docker-server=https://index.docker.io/v1/ \
          --docker-username="$DOCKER_USER" \
          --docker-password="$DOCKER_PASS" \
          --docker-email=alaayoussefnassar@gmail.com

  # 4. Generate and Apply ArgoCD Application Manifest
  - task: AWSShellScript@1
    displayName: Apply ArgoCD Application
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        
        cat <<EOF > argocd-app.yaml
        apiVersion: argoproj.io/v1alpha1
        kind: Application
        metadata:
          name: motivational-app
          namespace: argocd 
        spec:
          project: default
          source:
            repoURL: '$(GIT_REPO_URL)'
            targetRevision: HEAD
            path: $(HELM_CHART_PATH)
            helm:
              parameters:
                - name: "image.repository"
                  value: "$(IMAGE_REPOSITORY)"
                - name: "image.tag"
                  value: "latest"
                - name: "ingress.annotations.nginx\.ingress\.kubernetes\.io/auth-signin"
                  value: "$(APIGW_URL)/oauth2/start?rd=\$escaped_request_uri"
          destination:
            server: https://kubernetes.default.svc
            namespace: $(NAMESPACE)
          syncPolicy:
            automated:
              prune: true
              selfHeal: true
        EOF
        
        kubectl apply -f argocd-app.yaml