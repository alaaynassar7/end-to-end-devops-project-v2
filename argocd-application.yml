name: $(Date:yyyyMMdd)$(Rev:.r)-DirectDeploy
trigger: none
pr: none

variables:
  AWS_SERVICE_CONNECTION: 'alaa-s'
  AWS_REGION: 'us-east-1'
  CLUSTER_NAME: 'alaa-devops-project-cluster' 
  IMAGE_REPOSITORY: 'alaaynassar7/motivational-app'
  HELM_CHART_PATH: 'motivational-app-chart' 
  NAMESPACE: 'alaa'

pool:
  name: 'Self hosted pools'
  demands:
    - Agent.Name -equals alaaynassar-VMware

jobs:
- job: DirectDeploy
  displayName: 'Direct Helm Deployment'
  steps:
  - checkout: self

  # 1. Configure Kubeconfig and Fetch API Gateway URL
  - task: AWSShellScript@1
    displayName: Configure kubeconfig & Get APIGW
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        aws eks update-kubeconfig --name "$(CLUSTER_NAME)" --region "$(AWS_REGION)"
        
        APIGW_URL=$(aws apigatewayv2 get-apis --region "$(AWS_REGION)" --query "Items[?contains(Name, 'alaa-devops-project')].ApiEndpoint" --output text)
        
        if [ "$APIGW_URL" == "None" ] || [ -z "$APIGW_URL" ]; then
             APIGW_URL="https://placeholder-url.com"
        fi
        echo "##vso[task.setvariable variable=APIGW_URL]$APIGW_URL"

  # 2. Docker Login to generate credentials for Secret
  - task: Docker@2
    displayName: Docker Login
    inputs:
      command: login
      containerRegistry: 'alaa-docker'

  # 3. Create/Update Image Pull Secret
  - task: AWSShellScript@1
    displayName: Create Image Pull Secret
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        
        DOCKER_AUTH=$(cat ~/.docker/config.json | jq -r '.auths["https://index.docker.io/v1/"].auth' | base64 -d)
        DOCKER_USER=$(echo $DOCKER_AUTH | cut -d: -f1)
        DOCKER_PASS=$(echo $DOCKER_AUTH | cut -d: -f2-)

        kubectl create namespace $(NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -
        
        kubectl delete secret regcred -n $(NAMESPACE) --ignore-not-found
        kubectl create secret docker-registry regcred \
          --namespace $(NAMESPACE) \
          --docker-server=https://index.docker.io/v1/ \
          --docker-username="$DOCKER_USER" \
          --docker-password="$DOCKER_PASS" \
          --docker-email=alaayoussefnassar@gmail.com

  # 4. Direct Helm Upgrade/Install
  - task: AWSShellScript@1
    displayName: Helm Deploy
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        
        echo "ðŸš€ Starting Helm Upgrade for motivational-app..."
        
        helm upgrade --install motivational-app ./$(HELM_CHART_PATH) \
          --namespace $(NAMESPACE) \
          --create-namespace \
          --set image.repository=$(IMAGE_REPOSITORY) \
          --set image.tag=latest \
          --set "ingress.annotations.nginx\.ingress\.kubernetes\.io/auth-signin=$(APIGW_URL)/oauth2/start?rd=\$escaped_request_uri"