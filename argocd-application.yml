name: $(Date:yyyyMMdd)$(Rev:.r)-ArgoCD
trigger: none
pr: none

variables:
  AWS_SERVICE_CONNECTION: 'aws-alaa-2'
  AWS_REGION: 'us-east-2'
  CLUSTER_NAME: 'eks-platform-nonprod-v2-cluster'
cd  IMAGE_REPOSITORY: 'alaaynassar7/motivational-app'
  GIT_REPO_URL: 'https://github.com/alaaynassar7/end-to-end-devops-project-v2.git'
  HELM_CHART_PATH: 'motivational-app-chart' 
  NAMESPACE: 'alaa'

pool:
  name: 'Self hosted pools'
  demands:
    - Agent.Name -equals alaaynassar-VMware

jobs:
- job: ArgoSync
  displayName: 'ArgoCD Sync / Rollout'
  steps:
  - checkout: self

  # 1. Configure Kubeconfig & Fetch Network Details
  - task: AWSShellScript@1
    displayName: Configure kubeconfig
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        
        echo "Connecting to cluster: $(CLUSTER_NAME)..."
        aws eks update-kubeconfig --name "$(CLUSTER_NAME)" --region "$(AWS_REGION)"
        
        # Get API Gateway URL for ingress annotations
        APIGW_URL=$(aws apigatewayv2 get-apis --region "$(AWS_REGION)" --query "Items[?Name=='eks-platform-nonprod-v2-api-v2-nonprod'].ApiEndpoint" --output text)
        
        if [ "$APIGW_URL" == "None" ] || [ -z "$APIGW_URL" ]; then
             echo "##[warning]API Gateway not found."
             APIGW_URL="http://placeholder-url"
        else
             echo "Found API Gateway: $APIGW_URL"
        fi
        echo "##vso[task.setvariable variable=APIGW_URL]$APIGW_URL"

  # 2. Docker Login (Required to generate Secret)
  - task: Docker@2
    displayName: Docker Login
    inputs:
      command: login
      containerRegistry: 'alaa-docker'

  # 3. Create Docker Secret (ArgoCD needs this to pull image)
  - task: AWSShellScript@1
    displayName: Create Image Pull Secret
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        
        # Get Docker Config
        DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
        CONFIG_FILE="$DOCKER_CONFIG/config.json"
        
        # Extract Auth
        AUTH_STRING=$(python3 -c "import json; data = json.load(open('$CONFIG_FILE')); print(list(data['auths'].values())[0]['auth'])")
        DECODED_AUTH=$(echo "$AUTH_STRING" | base64 -d)
        DOCKER_USERNAME=$(echo "$DECODED_AUTH" | cut -d: -f1)
        DOCKER_PASSWORD=$(echo "$DECODED_AUTH" | cut -d: -f2-)

        # Create Namespace & Secret
        kubectl create namespace $(NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -
        
        kubectl delete secret regcred -n $(NAMESPACE) --ignore-not-found=true
        
        kubectl create secret docker-registry regcred \
          --namespace $(NAMESPACE) \
          --docker-server=https://index.docker.io/v1/ \
          --docker-username="$DOCKER_USERNAME" \
          --docker-password="$DOCKER_PASSWORD" \
          --docker-email=alaayoussefnassar@gmail.com
        
        echo "âœ… Docker Secret Created in namespace $(NAMESPACE)"

  # 4. Deploy ArgoCD Application (The "Radwa" Logic)
  - task: AWSShellScript@1
    displayName: Apply ArgoCD Application
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        
        echo "ðŸš€ Creating ArgoCD Application Manifest..."
        
        cat <<EOF > argocd-app.yaml
        apiVersion: argoproj.io/v1alpha1
        kind: Application
        metadata:
          name: motivational-app
          namespace: $(NAMESPACE) # ArgoCD is installed in 'alaa', app is managed here
        spec:
          project: default
          source:
            repoURL: '$(GIT_REPO_URL)'
            targetRevision: HEAD
            path: $(HELM_CHART_PATH)
            helm:
              parameters:
                - name: "image.repository"
                  value: "$(IMAGE_REPOSITORY)"
                - name: "image.tag"
                  value: "latest"
                - name: "ingress.annotations.nginx\.ingress\.kubernetes\.io/auth-signin"
                  value: "$(APIGW_URL)/oauth2/start?rd=\$escaped_request_uri"
          destination:
            server: https://kubernetes.default.svc
            namespace: $(NAMESPACE)
          syncPolicy:
            automated:
              prune: true
              selfHeal: true
            syncOptions:
              - CreateNamespace=true
        EOF
        
        # Apply to Cluster (ArgoCD will pick it up)
        # Assuming ArgoCD is installed in 'alaa' namespace (from Addons pipeline)
        kubectl apply -f argocd-app.yaml -n $(NAMESPACE)
        
        echo "âœ… ArgoCD Application created! Syncing..."
        
        # Optional: Force sync via CLI if needed (requires argocd cli login, usually unnecessary with auto-sync)
        # kubectl wait --for=condition=Healthy application/motivational-app -n $(NAMESPACE) --timeout=60s || echo "App syncing..."